<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!-- firebase -->
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-database.js"></script>
<!--
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-messaging.js"></script>
-->

<script>
(scope => {
  //let version = typeof Arcs === 'undefined' || !Arcs.version ? '/' : Arcs.version.replace(/\./g, '_');
  let db_version = '0_2_1';

  let firebaseConfig = {
    apiKey: "AIzaSyBme42moeI-2k8WgXh-6YK_wYyjEXo4Oz8",
    authDomain: "arcs-storage.firebaseapp.com",
    databaseURL: "https://arcs-storage.firebaseio.com",
    projectId: "arcs-storage",
    storageBucket: "arcs-storage.appspot.com",
    messagingSenderId: "779656349412"
  };

  let db = firebase.initializeApp(firebaseConfig, 'arcs-storage').database().ref(db_version);

  class ArcStore extends XenState(XenElement) {
    static get observedAttributes() { return ['key']; }
    _update(props, state, lastProps) {
      if ('key' in props && props.key === null) {
        this._createKey();
      }
    }
    _createKey() {
      let key =  this._arcsRef.push().key;
      ArcStore.log('createKey', key);
      this.dispatchEvent(new CustomEvent('key', {detail: key}));
    }
    get _db() {
      return db;
    }
    get _arcChild() {
      return this._db.child('arcs').child(this._props.key)
    }
    _child(path) {
      return path ? this._arcChild.child(path) : this._arcChild;
    }
    store(path, data) {
      ArcStore.log('store', path, data);
      this._child(path).set(data);
    }
    async fetch(path) {
      data = (await this._child(path).once('value')).val();
      ArcStore.log('fetch', path, data);
    }
    async dump(path) {
      let data = (await this._child(path).once('value')).val();
      ArcStore.log('dump', path, data);
    }
  }

  ArcStore.module = document.currentImport;
  ArcStore.log = XenBase.logFactory('ArcStore', '#a30000');
  customElements.define('arc-store', ArcStore);
})(this);
</script>
