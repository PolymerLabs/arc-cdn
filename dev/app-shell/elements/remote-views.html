<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<script>
  class RemoteViews extends XenBase {
    static get observedAttributes() { return ['arc', 'key', 'profiles']; }
    get _db() {
      return db;
    }
    _update(props, state, lastProps) {
      if (props.key && lastProps.key !== props.key) {
        state.needsWatch = true;
      }
      if (props.arc && state.needsWatch) {
        state.needsWatch = false;
        this._watchViews(props.key, props.arc, props.profiles);
      }
    }
    _watchViews(key, arc, areProfiles) {
      let remoteViews = this._db.child(`arcs/${key}/views`);
      this._off && this._off.forEach(w => w && w());
      this._off = [];
      this._state.watching = new Set();
      // Listen to new views being added.
      // TODO: remove views that are removed remotely.
      let cb = remoteViews.on('child_added', snapshot => {
        let metadata = snapshot.child('metadata').val();
        let type = Arcs.utils.typeFromMetaType(metadata.type);
        let id = Arcs.utils.getContextViewId(type, metadata.tags, snapshot.key, areProfiles);
        if (this._state.watching.has(id)) {
          return;
        }
        this._state.watching.add(id);
        RemoteViews.log(`Listening to remote context view ${snapshot.key}`);
        let localView = this._requireView(arc, type, metadata.name, id, metadata.tags);
        this._off.push(this._watchView(arc, localView, snapshot.child('values').ref));
      } );
      this._off.push(() => remoteViews.off('child_added', cb));
    }
    _watchView(arc, localView, remoteView) {
      let off = []
      if (localView.type.isSetView) {
        let cb = remoteView.on('child_added', data => {
          localView.store(data.val());
          this._fire('view', {view: localView});
        });
        off.push(() => remoteView.off('child_added', cb));
        cb = remoteView.on('child_removed', data => {
          localView.remove(data.val().id);
          this._fire('view', {view: localView});
        });
        off.push(() => remoteView.off('child_removed', cb));
      } else if (localView.type.isEntity) {
        let cb = remoteView.on('value', snapshot => {
          if (snapshot.val()) {
            localView.set(snapshot.val());
            this._fire('view', {view: localView});
          } else {
            localView.clear();
            this._fire('view', {view: localView});
          }
        });
        off.push(() => remoteView.off('value', cb));
      }
      return () => off.forEach(w => w && w());
    }
    _requireView(arc, type, name, id, tags) {
      return arc.context.findViewById(id) || arc.context.newView(type, name, id, tags);
    }
  }
  RemoteViews.module = document.currentImport;
  RemoteViews.log = XenBase.logFactory('RemoteViews', '#aa00c7');
  customElements.define('remote-views', RemoteViews);
</script>
